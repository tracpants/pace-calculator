<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pace Calculator Tests</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .pass { background-color: #d4edda; }
        .fail { background-color: #f8d7da; }
    </style>
</head>
<body>
    <h1>Pace Calculator Function Tests</h1>
    <div id="test-results"></div>

    <script type="module">
        import * as calc from './src/calculator.js';
        import * as pr from './src/pr.js';

        function runTest(name, fn) {
            try {
                const result = fn();
                if (result) {
                    document.getElementById('test-results').innerHTML += 
                        `<div class="test pass">✓ ${name}</div>`;
                } else {
                    document.getElementById('test-results').innerHTML += 
                        `<div class="test fail">✗ ${name} - Test failed</div>`;
                }
            } catch (error) {
                document.getElementById('test-results').innerHTML += 
                    `<div class="test fail">✗ ${name} - Error: ${error.message}</div>`;
            }
        }

        // Test parseTime function
        runTest("parseTime('45:30') should return 2730", () => {
            const result = calc.parseTime('45:30');
            console.log("parseTime('45:30'):", result);
            return result === 2730;
        });

        runTest("parseTime('04:30') should return 270", () => {
            const result = calc.parseTime('04:30');
            console.log("parseTime('04:30'):", result);
            return result === 270;
        });

        runTest("parseTime('01:35:00') should return 5700", () => {
            const result = calc.parseTime('01:35:00');
            console.log("parseTime('01:35:00'):", result);
            return result === 5700;
        });

        runTest("parseTime('') should return 0", () => {
            const result = calc.parseTime('');
            console.log("parseTime(''):", result);
            return result === 0;
        });

        // Test calculatePace function
        runTest("calculatePace with valid inputs should work", () => {
            const result = calc.calculatePace(2730, 10, 'km');
            console.log("calculatePace(2730, 10, 'km'):", result);
            return result.pacePerKm > 0 && result.pacePerMile > 0;
        });

        // Test calculateTime function
        runTest("calculateTime with valid inputs should work", () => {
            const result = calc.calculateTime(270, 21.1, 'km', 'km');
            console.log("calculateTime(270, 21.1, 'km', 'km'):", result);
            return result > 0;
        });

        // Test calculateDistance function
        runTest("calculateDistance with valid inputs should work", () => {
            const result = calc.calculateDistance(5700, 270, 'km');
            console.log("calculateDistance(5700, 270, 'km'):", result);
            return result.km > 0 && result.miles > 0;
        });

        // Test validation scenarios
        console.log("=== Validation Test Scenarios ===");
        
        // Simulate the exact validation logic from ui.js
        function testValidation(timeStr, distStr, tab) {
            console.log(`\nTesting ${tab} with time: '${timeStr}', dist: '${distStr}'`);
            
            if (tab === 'pace') {
                const time = calc.parseTime(timeStr);
                const dist = parseFloat(distStr);
                console.log(`Parsed: time=${time}, dist=${dist}, isNaN(dist)=${isNaN(dist)}`);
                const timeValid = time > 0;
                const distValid = dist > 0 && !isNaN(dist);
                const isValid = timeValid && distValid;
                console.log(`Time valid: ${timeValid}, Dist valid: ${distValid}, Overall: ${isValid}`);
                return isValid;
            }
            return false;
        }

        runTest("Validation test with default values '45:30' and '10'", () => {
            return testValidation('45:30', '10', 'pace');
        });

        runTest("Validation test with empty time", () => {
            return !testValidation('', '10', 'pace');
        });

        runTest("Validation test with zero distance", () => {
            return !testValidation('45:30', '0', 'pace');
        });

        runTest("Validation test with invalid distance", () => {
            return !testValidation('45:30', 'abc', 'pace');
        });

        // ===== PR COMPARISON TESTS =====
        console.log("\n=== PR Comparison Tests ===");

        // Setup test PRs
        function setupTestPRs() {
            // Clear any existing PRs
            localStorage.removeItem('pace-calculator-prs');
            
            // Add test PRs
            pr.setPR(5, 'km', 1305); // 21:45 for 5K
            pr.setPR(10, 'km', 2700); // 45:00 for 10K  
            pr.setPR(21.0975, 'km', 5700); // 1:35:00 for half marathon
        }

        // Test PR comparison calculations
        runTest("Setup test PRs", () => {
            setupTestPRs();
            const prs = pr.getAllPRs();
            console.log("Test PRs created:", prs.length);
            return prs.length === 3;
        });

        runTest("comparePaceWithPR - faster than PR", () => {
            const currentTime = 1260; // 21:00 for 5K (45 seconds faster than PR)
            const comparison = pr.comparePaceWithPR(currentTime, 5, 'km');
            console.log("Faster comparison result:", comparison);
            
            return comparison && 
                   comparison.hasPR && 
                   comparison.isFaster && 
                   !comparison.isSlower &&
                   comparison.timeDifference === -45 && // 45 seconds faster
                   Math.abs(comparison.timeDifferenceFormatted.indexOf('0:45')) >= 0;
        });

        runTest("comparePaceWithPR - slower than PR", () => {
            const currentTime = 1380; // 23:00 for 5K (75 seconds slower than PR)
            const comparison = pr.comparePaceWithPR(currentTime, 5, 'km');
            console.log("Slower comparison result:", comparison);
            
            return comparison && 
                   comparison.hasPR && 
                   !comparison.isFaster && 
                   comparison.isSlower &&
                   comparison.timeDifference === 75 && // 75 seconds slower
                   Math.abs(comparison.timeDifferenceFormatted.indexOf('1:15')) >= 0;
        });

        runTest("comparePaceWithPR - exact PR match", () => {
            const currentTime = 1305; // Exact PR time 21:45
            const comparison = pr.comparePaceWithPR(currentTime, 5, 'km');
            console.log("Exact match comparison result:", comparison);
            
            return comparison && 
                   comparison.hasPR && 
                   !comparison.isFaster && 
                   !comparison.isSlower &&
                   comparison.timeDifference === 0 &&
                   comparison.paceDifference === 0;
        });

        runTest("comparePaceWithPR - no PR exists", () => {
            const comparison = pr.comparePaceWithPR(1800, 1, 'miles'); // 1 mile, no PR exists
            console.log("No PR comparison result:", comparison);
            
            return comparison === null;
        });

        runTest("comparePaceWithPR - half marathon test", () => {
            const currentTime = 5400; // 1:30:00 for half marathon (5 minutes faster than PR)
            const comparison = pr.comparePaceWithPR(currentTime, 21.0975, 'km');
            console.log("Half marathon comparison result:", comparison);
            
            return comparison && 
                   comparison.hasPR && 
                   comparison.isFaster &&
                   comparison.timeDifference === -300 && // 5 minutes faster
                   Math.abs(comparison.timeDifferenceFormatted.indexOf('5:00')) >= 0;
        });

        // Test pace difference calculations
        runTest("Pace difference calculation accuracy", () => {
            const currentTime = 1350; // 22:30 for 5K
            const comparison = pr.comparePaceWithPR(currentTime, 5, 'km');
            
            // PR pace: 21:45 / 5km = 4:21/km = 261 seconds/km
            // Current pace: 22:30 / 5km = 4:30/km = 270 seconds/km
            // Difference: 9 seconds/km
            
            console.log("Pace calculation details:", {
                prPace: comparison?.prPace,
                currentPace: comparison?.currentPace,
                paceDifference: comparison?.paceDifference
            });
            
            return comparison && 
                   Math.abs(comparison.paceDifference - 9) < 1; // Within 1 second tolerance
        });

        // Test time formatting in comparisons
        runTest("Time difference formatting", () => {
            const currentTime = 1425; // 23:45 for 5K (2 minutes slower than PR)
            const comparison = pr.comparePaceWithPR(currentTime, 5, 'km');
            console.log("Time formatting result:", comparison);
            
            return comparison && 
                   comparison.timeDifference === 120 && // 2 minutes
                   comparison.timeDifferenceFormatted === '2:00';
        });

        // Test standard distance recognition
        runTest("Standard distance recognition", () => {
            // Test with slight variations in standard distances
            const comparison1 = pr.comparePaceWithPR(1300, 5.01, 'km'); // Slightly off 5K
            const comparison2 = pr.comparePaceWithPR(1300, 21.1, 'km'); // Close to half marathon
            
            console.log("Standard distance recognition:", {
                nearFiveK: comparison1?.hasPR,
                nearHalfMarathon: comparison2?.hasPR
            });
            
            return comparison1?.hasPR && comparison2?.hasPR;
        });

        // Test with different units
        runTest("PR comparison with miles", () => {
            // Add a mile PR
            pr.setPR(1, 'miles', 360); // 6:00 mile
            
            const currentTime = 390; // 6:30 mile (30 seconds slower)
            const comparison = pr.comparePaceWithPR(currentTime, 1, 'miles');
            console.log("Miles comparison result:", comparison);
            
            return comparison && 
                   comparison.hasPR && 
                   comparison.isSlower &&
                   comparison.timeDifference === 30;
        });

        // Test percentage calculation
        runTest("Percentage difference calculation", () => {
            const currentTime = 1435.5; // 23:55.5 for 5K
            const comparison = pr.comparePaceWithPR(currentTime, 5, 'km');
            
            // Should be about 10% slower
            console.log("Percentage calculation:", {
                percentage: comparison?.percentageDifference,
                expected: "around 10%"
            });
            
            return comparison && 
                   Math.abs(comparison.percentageDifference - 10) < 2; // Within 2% tolerance
        });

        // Edge case tests
        runTest("Very fast time comparison", () => {
            const currentTime = 900; // 15:00 for 5K (very fast)
            const comparison = pr.comparePaceWithPR(currentTime, 5, 'km');
            console.log("Very fast time comparison:", comparison);
            
            return comparison && 
                   comparison.isFaster &&
                   comparison.timeDifference < -300; // More than 5 minutes faster
        });

        runTest("Very slow time comparison", () => {
            const currentTime = 3000; // 50:00 for 5K (very slow)
            const comparison = pr.comparePaceWithPR(currentTime, 5, 'km');
            console.log("Very slow time comparison:", comparison);
            
            return comparison && 
                   comparison.isSlower &&
                   comparison.timeDifference > 1500; // More than 25 minutes slower
        });

        // Test data integrity
        runTest("PR data integrity after comparisons", () => {
            const prsBefore = pr.getAllPRs().length;
            
            // Run several comparisons
            pr.comparePaceWithPR(1300, 5, 'km');
            pr.comparePaceWithPR(2800, 10, 'km');
            pr.comparePaceWithPR(5500, 21.0975, 'km');
            
            const prsAfter = pr.getAllPRs().length;
            console.log("PR count integrity:", { before: prsBefore, after: prsAfter });
            
            return prsBefore === prsAfter; // PRs should not change during comparisons
        });

        console.log("\n=== All PR Comparison Tests Complete ===");
    </script>
</body>
</html>